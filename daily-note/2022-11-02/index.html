<!DOCTYPE html>
<html lang="en"
  dir="ltr">

<head>
  
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)'], ['$', '$']]  
    }
  };
</script>
  
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title> | </title>

      <link rel="stylesheet" href="/css/main.min.4e3925258a07dcd1db9457696be79fd505b229e2280d31f3f622c14c35c26655.css" integrity="sha256-TjklJYoH3NHblFdpa&#43;ef1QWyKeIoDTHz9iLBTDXCZlU=" crossorigin="anonymous">
      <link rel="stylesheet" href="/css/var.min.f4ad28441b010d71b331e4a3acd0878a1f12df0c47c4e6d09c5087fa963c50f8.css" integrity="sha256-9K0oRBsBDXGzMeSjrNCHih8S3wxHxObQnFCH&#43;pY8UPg=" crossorigin="anonymous">


      <script src="/js/main.f2979a93a325fecf9605263bd141398a311c8e23388ed7dcff74f92f7e632866.js" integrity="sha256-8peak6Ml/s&#43;WBSY70UE5ijEcjiM4jtfc/3T5L35jKGY=" crossorigin="anonymous"></script>


<link rel="icon" type="image/ico" href="/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="/favicon.ico">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

</head>

<body>
  <div class="aside-layout">
    <aside id="sidebar"> <header>
  <div style="display: flex;">
    <button id="sidebar-lhs-button" onclick="toggleVisibility()" class="sidebar-ico"></button>
  </div>

  <div>
    <nav aria-label="breadcrumb" class="breadcrumb" style="display: flex; align-items: center;">
  <style>
    ol {
      margin: 0;
    }

    li {
      margin: 0;
    }

    .breadcrumb ol {
      padding-left: 0;
    }

    .breadcrumb li {
      display: inline;
    }

    .breadcrumb li:not(:last-child)::after {
       
      color: var(--blue);
      content: "·";
    }
  </style>
  <ol>
    
    <li>
      <a href="/"></a>
    </li>
    
    <li>
      <a href="/daily-note/">Daily-Notes</a>
    </li>
    
    <li class="active">
      <a aria-current="page" href="/daily-note/2022-11-02/"></a>
    </li>
  </ol>
</nav>
  </div>
</header>

<div class="main-container">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">OVERVIEW</a></li>
    <li><a href="#kafka">Kafka</a></li>
    <li><a href="#docker">Docker</a></li>
    <li><a href="#spark-shuffle">Spark Shuffle</a>
      <ul>
        <li><a href="#shuffleexchangeexec">ShuffleExchangeExec</a></li>
        <li><a href="#sortshufflemanager">SortShuffleManager</a></li>
        <li><a href="#externalsorter">ExternalSorter</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div> </aside>
    <div id="right-board">
      <header> <div style="display: flex; align-items: center;">
  <button id="sidebar-rhs-button" style="display: none;" onclick="toggleVisibility()" class="sidebar-ico"></button>
  <a href="/" style="font-size: 2em; color: #222; text-decoration: none;">
    <span> HUAHUA </span>
  </a>
</div>

<div style="display: flex; align-items: center;">
  <button onclick="toggleEdit()" class="edit-ico" style="display: none;"></button>
  <button onclick="toggleSearch()" class="search-ico"></button>
  <a href="https://github.com/huahuak/huahuak.github.io">
    <span class="gh-ico"></span>
  </a>
</div>
 </header>
      <main class="center main-container">
        <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>
<style>
  .pagefind-ui__result-thumb.svelte-4xnkmf.svelte-4xnkmf {
    display: none;
  }
</style>
<div id="search" style="display: none; margin-top: 0.5em;"></div>
        

<h1 id="daily-note-11-02">Daily-Note 11-02</h1>
<h2 id="overview">OVERVIEW</h2>
<ol>
<li><strong>Kafka</strong>，分布式高性能事件流式处理平台。</li>
<li><strong>Docker</strong>，docker 是一个用于部署、传输、运行应用的开发平台。</li>
<li><strong>Spark Shuffle</strong>，分布式环境下重新组织数据使有序的操作。</li>
</ol>
<h2 id="kafka">Kafka</h2>
<blockquote>
<p><a href="https://kafka.apache.org/intro">Kafka introduction</a></p>
<p><a href="https://kafka.apache.org/documentation/#semantics">Kafka documentation</a></p>
</blockquote>
<h2 id="docker">Docker</h2>
<blockquote>
<p><a href="https://docs.docker.com/get-started/overview/">docker</a></p>
<p><a href="https://yeasy.gitbook.io/docker_practice/introduction/what">Docker 从入门到实践</a></p>
</blockquote>
<p><strong>EntryPoint</strong>，该命令相比于 CMD 命令而言，可以在 docker run 命令后添加参数。<a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/entrypoint">EntryPoint</a></p>
<h2 id="spark-shuffle">Spark Shuffle</h2>
<blockquote>
<p><a href="https://dataninjago.com/2022/01/20/spark-sql-query-engine-deep-dive-14-partitioning-ordering/">Spark SQL Query Engine Deep Dive (14) – Partitioning &amp; Ordering</a></p>
<p><a href="https://dataninjago.com/2022/01/23/spark-sql-query-engine-deep-dive-15-unsafeexternalsorter-sortexec/">Spark SQL Query Engine Deep Dive (15) – UnsafeExternalSorter &amp; SortExec</a></p>
<p><a href="https://dataninjago.com/2022/01/29/spark-sql-query-engine-deep-dive-shuffleexchangeexec-unsafeshufflewriter/">Spark SQL Query Engine Deep Dive (16) – ShuffleExchangeExec &amp; UnsafeShuffleWriter</a></p>
</blockquote>
<p>Shuffle 目的在于使 Map 端的输出重新组织，从而使得数据根据 Key 有序，方便后续的 Reduce 端进行数据聚合。在特定情况下，聚合也会提前在 Map 端执行，从而减少数据传输的大小。</p>
<p><strong>Overview</strong>，在物理计划 SparkPlan 由 Optimized 转换完成之后，进入 preparations 阶段，生成最后的 executedPlan，在 preparations 中的 EnsureRequirements 规则被应用，从而在需要 Shuffle 的算子之间插入对应的 SparkPlan，主要是 ShuffleExchangeExec。</p>
<p>1）在 ShuffleExchangeExec 中，应用对的 ShuffleDependency 生成 ShuffleRowRDD 用于构建 Reduce 端。</p>
<p>2）在整个 Plan 完成后，提交任务阶段，将在 <em>getMissingParentStages()</em> 中根据 Shuffledependency 划分得到 ShuffleMapStage 和 ResultStage，并在后续的 <em>submitMissingTasks()</em> 中根据对应的 Stage 生成相对的 ShuffleMapTask 和 ResultTask，在 ShuffleMapTask 中，根据对应的 dependency 调用 ShuffleWriterProcesser 的 <em>write()</em> 将 MapOut 写出到指定的 partitions 中。</p>
<p>从而完成 Shuffle 两端 Map 和 Reduce 的职能划分。</p>
<h3 id="shuffleexchangeexec">ShuffleExchangeExec</h3>
<p><strong>ShuffleExchangeExec</strong>，用于执行 Shuffle 的 SparkPlan，在物理计划的规则 EnsureRequirements 中插入需要 Shuffle 的 Spark Plan 之间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">protected</span> <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">doExecute</span><span style="color:#000">()</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">RDD</span><span style="color:#000">[</span><span style="color:#a90d91">InternalRow</span><span style="color:#000">]</span> <span style="color:#a90d91">=</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#177500">// Returns the same ShuffleRowRDD if this plan is used by multiple plans.
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>  <span style="color:#a90d91">if</span> <span style="color:#000">(</span><span style="color:#000">cachedShuffleRDD</span> <span style="color:#000">==</span> <span style="color:#a90d91">null</span><span style="color:#000">)</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cachedShuffleRDD</span> <span style="color:#a90d91">=</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">ShuffledRowRDD</span><span style="color:#000">(</span><span style="color:#000">shuffleDependency</span><span style="color:#000">,</span> <span style="color:#000">readMetrics</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cachedShuffleRDD</span>
</span></span><span style="display:flex;"><span><span style="color:#000">}</span>
</span></span></code></pre></div><p>在 <em>doExecute()</em> 中构建并缓存 ShuffleRowRDD，其中 shuffledependency 由 <em>prepareShuffleDependency()</em> 获得。</p>
<p>在 <em>prepareShuffleDependency()</em> 方法中，整体上看，首先获取对应的 part，接着根据 <em>getPartitionKeyExtractor()</em> 得到 row 中需要有序的 key，最后根据 part 和 <em>getPartitionKey</em> 获取对应的记录的 partitionId，最后生成 MutablePair 用于后续的分区。</p>
<pre tabindex="0"><code class="language-mermaid" data-lang="mermaid">graph TD
  A(part:Partitioner)
  B(getPartitionKey: InternalRow =&gt; Any)
  C(rddWithPartitionIds:MutablePair)
  D(dependency:Shuffledependency)
  A--&gt;C
  B--&gt;C
  C--&gt;D
</code></pre><p>首先根据 newPartitioning 属性匹配对应的 partitioner。这里的 newpartitioning 属性来自于 ShuffleExchangExec 的 outputpartitioning，而 outputpartitioning 则是在创建 ShuffleExchangeExec 时由前一个 SparkPlan 的 requiredDistribution 决定的。即在生成父节点的物理计划时，指定子节点需要满足的 partitioning。</p>
<p>其中 Distribution 在 Spark v3.3.1 包括：</p>
<ul>
<li>
<p>UnspecifiedDistribution，该 distribution 即不需要特定的分区分布</p>
</li>
<li>
<p>AllTuples，要求所有 record 在一个分区内。</p>
</li>
<li>
<p>BroadcastDistribution，使分区广播到所有的节点。</p>
</li>
<li>
<p><strong>ClustertedDistribution</strong>，根据 Clustering Expression 将分区的 record hash 到对应的分区中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">createPartitioning</span><span style="color:#000">(</span><span style="color:#000">numPartitions</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Partitioning</span> <span style="color:#000">=</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">assert</span><span style="color:#000">(</span><span style="color:#000">requiredNumPartitions</span><span style="color:#000">.</span><span style="color:#000">isEmpty</span> <span style="color:#000">||</span> <span style="color:#000">requiredNumPartitions</span><span style="color:#000">.</span><span style="color:#000">get</span> <span style="color:#000">==</span> <span style="color:#000">numPartitions</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#c41a16">s&#34;This ClusteredDistribution requires </span><span style="color:#c41a16">${</span><span style="color:#000">requiredNumPartitions</span><span style="color:#000">.</span><span style="color:#000">get</span><span style="color:#c41a16">}</span><span style="color:#c41a16"> partitions, but &#34;</span> <span style="color:#000">+</span>
</span></span><span style="display:flex;"><span>      <span style="color:#c41a16">s&#34;the actual number of partitions is </span><span style="color:#c41a16">$numPartitions</span><span style="color:#c41a16">.&#34;</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#3f6e75">HashPartitioning</span><span style="color:#000">(</span><span style="color:#000">clustering</span><span style="color:#000">,</span> <span style="color:#000">numPartitions</span><span style="color:#000">)</span> <span style="color:#177500">// 使用 hashpartitioning 策略
</span></span></span></code></pre></div></li>
<li>
<p>StatefulOpClusteredDistribution</p>
</li>
<li>
<p><strong>OrderedDistribution</strong>，要求相邻分区之间有序，但不要求分区内记录有序。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">createPartitioning</span><span style="color:#000">(</span><span style="color:#000">numPartitions</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Partitioning</span> <span style="color:#000">=</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#3f6e75">RangePartitioning</span><span style="color:#000">(</span><span style="color:#000">ordering</span><span style="color:#000">,</span> <span style="color:#000">numPartitions</span><span style="color:#000">)</span> <span style="color:#177500">//使用 rangepartitioning 策略
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">}</span>
</span></span></code></pre></div></li>
</ul>
<p>不同的分区使用不同的 partitioning 实现将记录移动到指定的分区中，即实现 Shuffle。在 <em>prepareShuffleDependency()</em> 中，根据 newPartitioning 来获取对应的 partitioning。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">val</span> <span style="color:#000">part</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Partitioner</span> <span style="color:#000">=</span> <span style="color:#000">newPartitioning</span> <span style="color:#a90d91">match</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#3f6e75">RoundRobinPartitioning</span><span style="color:#000">(</span><span style="color:#000">numPartitions</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">HashPartitioner</span><span style="color:#000">(</span><span style="color:#000">numPartitions</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#3f6e75">HashPartitioning</span><span style="color:#000">(</span><span style="color:#a90d91">_</span><span style="color:#000">,</span> <span style="color:#000">n</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">new</span> <span style="color:#3f6e75">Partitioner</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">numPartitions</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span> <span style="color:#000">=</span> <span style="color:#000">n</span>
</span></span><span style="display:flex;"><span>      <span style="color:#177500">// For HashPartitioning, the partitioning key is already a valid partition ID, as we use
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>      <span style="color:#177500">// `HashPartitioning.partitionIdExpression` to produce partitioning key.
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>      <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">getPartition</span><span style="color:#000">(</span><span style="color:#000">key</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Any</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span> <span style="color:#000">=</span> <span style="color:#000">key</span><span style="color:#000">.</span><span style="color:#000">asInstanceOf</span><span style="color:#000">[</span><span style="color:#a90d91">Int</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#3f6e75">RangePartitioning</span><span style="color:#000">(</span><span style="color:#000">sortingExpressions</span><span style="color:#000">,</span> <span style="color:#000">numPartitions</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">// Extract only fields used for sorting to avoid collecting large fields that does not
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">// affect sorting result when deciding partition bounds in RangePartitioner
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">val</span> <span style="color:#000">rddForSampling</span> <span style="color:#a90d91">=</span> <span style="color:#000">rdd</span><span style="color:#000">.</span><span style="color:#000">mapPartitionsInternal</span> <span style="color:#000">{</span> <span style="color:#000">iter</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">val</span> <span style="color:#000">projection</span> <span style="color:#a90d91">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3f6e75">UnsafeProjection</span><span style="color:#000">.</span><span style="color:#000">create</span><span style="color:#000">(</span><span style="color:#000">sortingExpressions</span><span style="color:#000">.</span><span style="color:#000">map</span><span style="color:#000">(</span><span style="color:#a90d91">_</span><span style="color:#000">.</span><span style="color:#000">child</span><span style="color:#000">),</span> <span style="color:#000">outputAttributes</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">val</span> <span style="color:#000">mutablePair</span> <span style="color:#a90d91">=</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">MutablePair</span><span style="color:#000">[</span><span style="color:#a90d91">InternalRow</span>, <span style="color:#a90d91">Null</span><span style="color:#000">]()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#177500">// Internally, RangePartitioner runs a job on the RDD that samples keys to compute
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>      <span style="color:#177500">// partition bounds. To get accurate samples, we need to copy the mutable keys.
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>      <span style="color:#000">iter</span><span style="color:#000">.</span><span style="color:#000">map</span><span style="color:#000">(</span><span style="color:#000">row</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">mutablePair</span><span style="color:#000">.</span><span style="color:#000">update</span><span style="color:#000">(</span><span style="color:#000">projection</span><span style="color:#000">(</span><span style="color:#000">row</span><span style="color:#000">).</span><span style="color:#000">copy</span><span style="color:#000">(),</span> <span style="color:#a90d91">null</span><span style="color:#000">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">// Construct ordering on extracted sort key.
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">val</span> <span style="color:#000">orderingAttributes</span> <span style="color:#a90d91">=</span> <span style="color:#000">sortingExpressions</span><span style="color:#000">.</span><span style="color:#000">zipWithIndex</span><span style="color:#000">.</span><span style="color:#000">map</span> <span style="color:#000">{</span> <span style="color:#a90d91">case</span> <span style="color:#000">(</span><span style="color:#000">ord</span><span style="color:#000">,</span> <span style="color:#000">i</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">ord</span><span style="color:#000">.</span><span style="color:#000">copy</span><span style="color:#000">(</span><span style="color:#000">child</span> <span style="color:#a90d91">=</span> <span style="color:#3f6e75">BoundReference</span><span style="color:#000">(</span><span style="color:#000">i</span><span style="color:#000">,</span> <span style="color:#000">ord</span><span style="color:#000">.</span><span style="color:#000">dataType</span><span style="color:#000">,</span> <span style="color:#000">ord</span><span style="color:#000">.</span><span style="color:#000">nullable</span><span style="color:#000">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">implicit</span> <span style="color:#a90d91">val</span> <span style="color:#000">ordering</span> <span style="color:#a90d91">=</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">LazilyGeneratedOrdering</span><span style="color:#000">(</span><span style="color:#000">orderingAttributes</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">new</span> <span style="color:#3f6e75">RangePartitioner</span><span style="color:#000">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">numPartitions</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">rddForSampling</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">ascending</span> <span style="color:#a90d91">=</span> <span style="color:#a90d91">true</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">samplePointsPerPartitionHint</span> <span style="color:#a90d91">=</span> <span style="color:#3f6e75">SQLConf</span><span style="color:#000">.</span><span style="color:#000">get</span><span style="color:#000">.</span><span style="color:#000">rangeExchangeSampleSizePerPartition</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#3f6e75">SinglePartition</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">new</span> <span style="color:#3f6e75">Partitioner</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">numPartitions</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">getPartition</span><span style="color:#000">(</span><span style="color:#000">key</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Any</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#a90d91">_</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#a90d91">throw</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">IllegalStateException</span><span style="color:#000">(</span><span style="color:#c41a16">s&#34;Exchange not implemented for </span><span style="color:#c41a16">$newPartitioning</span><span style="color:#c41a16">&#34;</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#177500">// TODO: Handle BroadcastPartitioning.
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">}</span>
</span></span></code></pre></div><p>不同的 partitioning 由不同的 Pationer 实现其分区需求。</p>
<p>Partitioner 主要包括：</p>
<ul>
<li>RoundRobinPartitioning</li>
<li><strong>HashPartitioning</strong>，通过 hash 的方式将 record key 放入指定的分区，这里 hash partitioning 的 record key 在提取时，已经完成 hash，因此 <em>getPartition()</em> 直接返回即可。</li>
<li><strong>RangePartitioning</strong>，</li>
<li>SinglePartition</li>
</ul>
<p>接着 <em>getPartitionKeyExtractor()</em> 将返回一个提取 record 中的 partition key 的 lambda 方法。利用该方法获取 Partitioner 的 <em>getPartitionKey(key)</em> 的输入参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">def</span> <span style="color:#000">getPartitionKeyExtractor</span><span style="color:#000">()</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">InternalRow</span> <span style="color:#000">=&gt;</span> <span style="color:#3f6e75">Any</span> <span style="color:#a90d91">=</span> <span style="color:#000">newPartitioning</span> <span style="color:#a90d91">match</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#3f6e75">RoundRobinPartitioning</span><span style="color:#000">(</span><span style="color:#000">numPartitions</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">// Distributes elements evenly across output partitions, starting from a random partition.
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">// nextInt(numPartitions) implementation has a special case when bound is a power of 2,
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">// which is basically taking several highest bits from the initial seed, with only a
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">// minimal scrambling. Due to deterministic seed, using the generator only once,
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">// and lack of scrambling, the position values for power-of-two numPartitions always
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">// end up being almost the same regardless of the index. substantially scrambling the
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">// seed by hashing will help. Refer to SPARK-21782 for more details.
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">val</span> <span style="color:#000">partitionId</span> <span style="color:#a90d91">=</span> <span style="color:#3f6e75">TaskContext</span><span style="color:#000">.</span><span style="color:#000">get</span><span style="color:#000">().</span><span style="color:#000">partitionId</span><span style="color:#000">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">var</span> <span style="color:#000">position</span> <span style="color:#a90d91">=</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">XORShiftRandom</span><span style="color:#000">(</span><span style="color:#000">partitionId</span><span style="color:#000">).</span><span style="color:#000">nextInt</span><span style="color:#000">(</span><span style="color:#000">numPartitions</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">(</span><span style="color:#000">row</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">InternalRow</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#177500">// The HashPartitioner will handle the `mod` by the number of partitions
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>      <span style="color:#000">position</span> <span style="color:#000">+=</span> <span style="color:#1c01ce">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">position</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#000">h</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">HashPartitioning</span> <span style="color:#000">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">val</span> <span style="color:#000">projection</span> <span style="color:#a90d91">=</span> <span style="color:#3f6e75">UnsafeProjection</span><span style="color:#000">.</span><span style="color:#000">create</span><span style="color:#000">(</span><span style="color:#000">h</span><span style="color:#000">.</span><span style="color:#000">partitionIdExpression</span> <span style="color:#a90d91">:</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Nil</span><span style="color:#000">,</span> <span style="color:#000">outputAttributes</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">row</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">projection</span><span style="color:#000">(</span><span style="color:#000">row</span><span style="color:#000">).</span><span style="color:#000">getInt</span><span style="color:#000">(</span><span style="color:#1c01ce">0</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#3f6e75">RangePartitioning</span><span style="color:#000">(</span><span style="color:#000">sortingExpressions</span><span style="color:#000">,</span> <span style="color:#a90d91">_</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">val</span> <span style="color:#000">projection</span> <span style="color:#a90d91">=</span> <span style="color:#3f6e75">UnsafeProjection</span><span style="color:#000">.</span><span style="color:#000">create</span><span style="color:#000">(</span><span style="color:#000">sortingExpressions</span><span style="color:#000">.</span><span style="color:#000">map</span><span style="color:#000">(</span><span style="color:#a90d91">_</span><span style="color:#000">.</span><span style="color:#000">child</span><span style="color:#000">),</span> <span style="color:#000">outputAttributes</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">row</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">projection</span><span style="color:#000">(</span><span style="color:#000">row</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#3f6e75">SinglePartition</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">identity</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#a90d91">_</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#a90d91">throw</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">IllegalStateException</span><span style="color:#000">(</span><span style="color:#c41a16">s&#34;Exchange not implemented for </span><span style="color:#c41a16">$newPartitioning</span><span style="color:#c41a16">&#34;</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">}</span>
</span></span></code></pre></div><p>其中 HashPartitioning 利用 UnsafeProjection 构造 Expression 获取对应的 record 的 hash。RangePartitioning 则利用 sortingExpression 返回需要 order 的 key。</p>
<p>最后构建一个新的 MutablePair，由 &lt;partitionId, row&gt; 构成。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">val</span> <span style="color:#000">rddWithPartitionIds</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">RDD</span><span style="color:#000">[</span><span style="color:#a90d91">Product2</span><span style="color:#000">[</span><span style="color:#a90d91">Int</span>, <span style="color:#a90d91">InternalRow</span><span style="color:#000">]]</span> <span style="color:#a90d91">=</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span> <span style="color:#177500">// ... 
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>  <span style="color:#000">newRdd</span><span style="color:#000">.</span><span style="color:#000">mapPartitionsWithIndexInternal</span><span style="color:#000">((</span><span style="color:#a90d91">_</span><span style="color:#000">,</span> <span style="color:#000">iter</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">val</span> <span style="color:#000">getPartitionKey</span> <span style="color:#a90d91">=</span> <span style="color:#000">getPartitionKeyExtractor</span><span style="color:#000">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">val</span> <span style="color:#000">mutablePair</span> <span style="color:#a90d91">=</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">MutablePair</span><span style="color:#000">[</span><span style="color:#a90d91">Int</span>, <span style="color:#a90d91">InternalRow</span><span style="color:#000">]()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iter</span><span style="color:#000">.</span><span style="color:#000">map</span> <span style="color:#000">{</span> <span style="color:#000">row</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">mutablePair</span><span style="color:#000">.</span><span style="color:#000">update</span><span style="color:#000">(</span><span style="color:#000">part</span><span style="color:#000">.</span><span style="color:#000">getPartition</span><span style="color:#000">(</span><span style="color:#000">getPartitionKey</span><span style="color:#000">(</span><span style="color:#000">row</span><span style="color:#000">)),</span> <span style="color:#000">row</span><span style="color:#000">)</span> <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">},</span> <span style="color:#000">isOrderSensitive</span> <span style="color:#a90d91">=</span> <span style="color:#000">isOrderSensitive</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">}</span>
</span></span></code></pre></div><p>并基于此构造对应的 dependency。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">val</span> <span style="color:#000">dependency</span> <span style="color:#a90d91">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">new</span> <span style="color:#3f6e75">ShuffleDependency</span><span style="color:#000">[</span><span style="color:#a90d91">Int</span>, <span style="color:#a90d91">InternalRow</span>, <span style="color:#a90d91">InternalRow</span><span style="color:#000">](</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rddWithPartitionIds</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">new</span> <span style="color:#3f6e75">PartitionIdPassthrough</span><span style="color:#000">(</span><span style="color:#000">part</span><span style="color:#000">.</span><span style="color:#000">numPartitions</span><span style="color:#000">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">serializer</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">shuffleWriterProcessor</span> <span style="color:#a90d91">=</span> <span style="color:#000">createShuffleWriteProcessor</span><span style="color:#000">(</span><span style="color:#000">writeMetrics</span><span style="color:#000">))</span>
</span></span></code></pre></div><h3 id="sortshufflemanager">SortShuffleManager</h3>
<p><strong>SortshuffleManager</strong>，主要实现了三个方法，<em>registerShuffle/getReader/getWriter</em>。</p>
<p>其中 <em>registerShuffle</em> 主要将自己注册到 dependency 中，在任务反序列化时，将 handle 传入获取对应的 writer。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">registerShuffle</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">V</span>, <span style="color:#a90d91">C</span><span style="color:#000">](</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">shuffleId</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dependency</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">ShuffleDependency</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">V</span>, <span style="color:#a90d91">C</span><span style="color:#000">])</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">ShuffleHandle</span> <span style="color:#000">=</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">if</span> <span style="color:#000">(</span><span style="color:#3f6e75">SortShuffleWriter</span><span style="color:#000">.</span><span style="color:#000">shouldBypassMergeSort</span><span style="color:#000">(</span><span style="color:#000">conf</span><span style="color:#000">,</span> <span style="color:#000">dependency</span><span style="color:#000">))</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">// If there are fewer than spark.shuffle.sort.bypassMergeThreshold partitions and we don&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">// need map-side aggregation, then write numPartitions files directly and just concatenate
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">// them at the end. This avoids doing serialization and deserialization twice to merge
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">// together the spilled files, which would happen with the normal code path. The downside is
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">// having multiple files open at a time and thus more memory allocated to buffers.
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">new</span> <span style="color:#3f6e75">BypassMergeSortShuffleHandle</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">V</span><span style="color:#000">](</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">shuffleId</span><span style="color:#000">,</span> <span style="color:#000">dependency</span><span style="color:#000">.</span><span style="color:#000">asInstanceOf</span><span style="color:#000">[</span><span style="color:#a90d91">ShuffleDependency</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">V</span>, <span style="color:#a90d91">V</span><span style="color:#000">]])</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">}</span> <span style="color:#a90d91">else</span> <span style="color:#a90d91">if</span> <span style="color:#000">(</span><span style="color:#3f6e75">SortShuffleManager</span><span style="color:#000">.</span><span style="color:#000">canUseSerializedShuffle</span><span style="color:#000">(</span><span style="color:#000">dependency</span><span style="color:#000">))</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">// Otherwise, try to buffer map outputs in a serialized form, since this is more efficient:
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">new</span> <span style="color:#3f6e75">SerializedShuffleHandle</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">V</span><span style="color:#000">](</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">shuffleId</span><span style="color:#000">,</span> <span style="color:#000">dependency</span><span style="color:#000">.</span><span style="color:#000">asInstanceOf</span><span style="color:#000">[</span><span style="color:#a90d91">ShuffleDependency</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">V</span>, <span style="color:#a90d91">V</span><span style="color:#000">]])</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">}</span> <span style="color:#a90d91">else</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">// Otherwise, buffer map outputs in a deserialized form:
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">new</span> <span style="color:#3f6e75">BaseShuffleHandle</span><span style="color:#000">(</span><span style="color:#000">shuffleId</span><span style="color:#000">,</span> <span style="color:#000">dependency</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">}</span>
</span></span></code></pre></div><p><em>getWriter()</em> 根据 handle 获取对应的 writer，利用 writer 将 RDD 的计算结果 Iterator 写出到对应的文件中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">getWriter</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">V</span><span style="color:#000">](</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">handle</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">ShuffleHandle</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mapId</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Long</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">context</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">TaskContext</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">metrics</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">ShuffleWriteMetricsReporter</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">ShuffleWriter</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">V</span><span style="color:#000">]</span> <span style="color:#a90d91">=</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">val</span> <span style="color:#000">mapTaskIds</span> <span style="color:#a90d91">=</span> <span style="color:#000">taskIdMapsForShuffle</span><span style="color:#000">.</span><span style="color:#000">computeIfAbsent</span><span style="color:#000">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">handle</span><span style="color:#000">.</span><span style="color:#000">shuffleId</span><span style="color:#000">,</span> <span style="color:#a90d91">_</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#a90d91">new</span> <span style="color:#3f6e75">OpenHashSet</span><span style="color:#000">[</span><span style="color:#a90d91">Long</span><span style="color:#000">](</span><span style="color:#1c01ce">16</span><span style="color:#000">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">mapTaskIds</span><span style="color:#000">.</span><span style="color:#000">synchronized</span> <span style="color:#000">{</span> <span style="color:#000">mapTaskIds</span><span style="color:#000">.</span><span style="color:#000">add</span><span style="color:#000">(</span><span style="color:#000">mapId</span><span style="color:#000">)</span> <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">val</span> <span style="color:#000">env</span> <span style="color:#a90d91">=</span> <span style="color:#3f6e75">SparkEnv</span><span style="color:#000">.</span><span style="color:#000">get</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">handle</span> <span style="color:#a90d91">match</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">case</span> <span style="color:#000">unsafeShuffleHandle</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">SerializedShuffleHandle</span><span style="color:#000">[</span><span style="color:#a90d91">K</span> <span style="color:#a90d91">@unchecked</span>, <span style="color:#a90d91">V</span> <span style="color:#a90d91">@unchecked</span><span style="color:#000">]</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">new</span> <span style="color:#3f6e75">UnsafeShuffleWriter</span><span style="color:#000">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">env</span><span style="color:#000">.</span><span style="color:#000">blockManager</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">context</span><span style="color:#000">.</span><span style="color:#000">taskMemoryManager</span><span style="color:#000">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">unsafeShuffleHandle</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mapId</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">context</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">env</span><span style="color:#000">.</span><span style="color:#000">conf</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">metrics</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">shuffleExecutorComponents</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">case</span> <span style="color:#000">bypassMergeSortHandle</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">BypassMergeSortShuffleHandle</span><span style="color:#000">[</span><span style="color:#a90d91">K</span> <span style="color:#a90d91">@unchecked</span>, <span style="color:#a90d91">V</span> <span style="color:#a90d91">@unchecked</span><span style="color:#000">]</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">new</span> <span style="color:#3f6e75">BypassMergeSortShuffleWriter</span><span style="color:#000">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">env</span><span style="color:#000">.</span><span style="color:#000">blockManager</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bypassMergeSortHandle</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mapId</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">env</span><span style="color:#000">.</span><span style="color:#000">conf</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">metrics</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">shuffleExecutorComponents</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">case</span> <span style="color:#000">other</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">BaseShuffleHandle</span><span style="color:#000">[</span><span style="color:#a90d91">K</span> <span style="color:#a90d91">@unchecked</span>, <span style="color:#a90d91">V</span> <span style="color:#a90d91">@unchecked</span>, <span style="color:#a90d91">_</span><span style="color:#000">]</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">new</span> <span style="color:#3f6e75">SortShuffleWriter</span><span style="color:#000">(</span><span style="color:#000">other</span><span style="color:#000">,</span> <span style="color:#000">mapId</span><span style="color:#000">,</span> <span style="color:#000">context</span><span style="color:#000">,</span> <span style="color:#000">shuffleExecutorComponents</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">}</span>
</span></span></code></pre></div><p>在 BypassMergeSortShuffleHandle 中 <em>write()</em> 将调用 ShuffleExchangExec 中的 Partitioner 将记录写出到指定的分区中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">while</span> <span style="color:#000">(</span><span style="color:#000">records</span><span style="color:#000">.</span><span style="color:#000">hasNext</span><span style="color:#000">())</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">final</span> <span style="color:#3f6e75">Product2</span><span style="color:#000">&lt;</span><span style="color:#000">K</span><span style="color:#000">,</span> <span style="color:#000">V</span><span style="color:#000">&gt;</span> <span style="color:#000">record</span> <span style="color:#a90d91">=</span> <span style="color:#000">records</span><span style="color:#000">.</span><span style="color:#000">next</span><span style="color:#000">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">final</span> <span style="color:#000">K</span> <span style="color:#000">key</span> <span style="color:#a90d91">=</span> <span style="color:#000">record</span><span style="color:#000">.</span><span style="color:#000">_1</span><span style="color:#000">();</span> <span style="color:#177500">// key
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>  <span style="color:#177500">// partitioner 
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>  <span style="color:#000">partitionWriters</span><span style="color:#000">[</span><span style="color:#a90d91">partitioner.getPartition</span><span style="color:#000">(</span><span style="color:#a90d91">key</span><span style="color:#000">)].</span><span style="color:#000">write</span><span style="color:#000">(</span><span style="color:#000">key</span><span style="color:#000">,</span> <span style="color:#000">record</span><span style="color:#000">.</span><span style="color:#000">_2</span><span style="color:#000">());</span> 
</span></span><span style="display:flex;"><span><span style="color:#000">}</span>
</span></span></code></pre></div><p><em>getReader()</em> 根据 mapOutputTracker 获取 partition 的地址后，构建对应的 BlockStoreShuffleReader 用于获取 shuffle 的 mapout。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">override</span> <span style="color:#a90d91">def</span> <span style="color:#000">getReader</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">C</span><span style="color:#000">](</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">handle</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">ShuffleHandle</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">startMapIndex</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">endMapIndex</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">startPartition</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">endPartition</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Int</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">context</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">TaskContext</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">metrics</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">ShuffleReadMetricsReporter</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">ShuffleReader</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">C</span><span style="color:#000">]</span> <span style="color:#a90d91">=</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">val</span> <span style="color:#000">baseShuffleHandle</span> <span style="color:#a90d91">=</span> <span style="color:#000">handle</span><span style="color:#000">.</span><span style="color:#000">asInstanceOf</span><span style="color:#000">[</span><span style="color:#a90d91">BaseShuffleHandle</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">_</span>, <span style="color:#a90d91">C</span><span style="color:#000">]]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">val</span> <span style="color:#000">(</span><span style="color:#000">blocksByAddress</span><span style="color:#000">,</span> <span style="color:#000">canEnableBatchFetch</span><span style="color:#000">)</span> <span style="color:#a90d91">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span> <span style="color:#000">(</span><span style="color:#000">baseShuffleHandle</span><span style="color:#000">.</span><span style="color:#000">dependency</span><span style="color:#000">.</span><span style="color:#000">isShuffleMergeFinalizedMarked</span><span style="color:#000">)</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">val</span> <span style="color:#000">res</span> <span style="color:#a90d91">=</span> <span style="color:#3f6e75">SparkEnv</span><span style="color:#000">.</span><span style="color:#000">get</span><span style="color:#000">.</span><span style="color:#000">mapOutputTracker</span><span style="color:#000">.</span><span style="color:#000">getPushBasedShuffleMapSizesByExecutorId</span><span style="color:#000">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">handle</span><span style="color:#000">.</span><span style="color:#000">shuffleId</span><span style="color:#000">,</span> <span style="color:#000">startMapIndex</span><span style="color:#000">,</span> <span style="color:#000">endMapIndex</span><span style="color:#000">,</span> <span style="color:#000">startPartition</span><span style="color:#000">,</span> <span style="color:#000">endPartition</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">(</span><span style="color:#000">res</span><span style="color:#000">.</span><span style="color:#000">iter</span><span style="color:#000">,</span> <span style="color:#000">res</span><span style="color:#000">.</span><span style="color:#000">enableBatchFetch</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">}</span> <span style="color:#a90d91">else</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">val</span> <span style="color:#000">address</span> <span style="color:#a90d91">=</span> <span style="color:#3f6e75">SparkEnv</span><span style="color:#000">.</span><span style="color:#000">get</span><span style="color:#000">.</span><span style="color:#000">mapOutputTracker</span><span style="color:#000">.</span><span style="color:#000">getMapSizesByExecutorId</span><span style="color:#000">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">handle</span><span style="color:#000">.</span><span style="color:#000">shuffleId</span><span style="color:#000">,</span> <span style="color:#000">startMapIndex</span><span style="color:#000">,</span> <span style="color:#000">endMapIndex</span><span style="color:#000">,</span> <span style="color:#000">startPartition</span><span style="color:#000">,</span> <span style="color:#000">endPartition</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">(</span><span style="color:#000">address</span><span style="color:#000">,</span> <span style="color:#a90d91">true</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">new</span> <span style="color:#3f6e75">BlockStoreShuffleReader</span><span style="color:#000">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">handle</span><span style="color:#000">.</span><span style="color:#000">asInstanceOf</span><span style="color:#000">[</span><span style="color:#a90d91">BaseShuffleHandle</span><span style="color:#000">[</span><span style="color:#a90d91">K</span>, <span style="color:#a90d91">_</span>, <span style="color:#a90d91">C</span><span style="color:#000">]],</span> <span style="color:#000">blocksByAddress</span><span style="color:#000">,</span> <span style="color:#000">context</span><span style="color:#000">,</span> <span style="color:#000">metrics</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">shouldBatchFetch</span> <span style="color:#a90d91">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">canEnableBatchFetch</span> <span style="color:#000">&amp;&amp;</span> <span style="color:#000">canUseBatchFetch</span><span style="color:#000">(</span><span style="color:#000">startPartition</span><span style="color:#000">,</span> <span style="color:#000">endPartition</span><span style="color:#000">,</span> <span style="color:#000">context</span><span style="color:#000">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">}</span>
</span></span></code></pre></div><p><strong>Writer &amp; Reader CALL</strong></p>
<p>在 ShuffleMapTask 中通过调用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#000">dep</span><span style="color:#000">.</span><span style="color:#000">shuffleWriterProcessor</span><span style="color:#000">.</span><span style="color:#000">write</span><span style="color:#000">(</span><span style="color:#000">rdd</span><span style="color:#000">,</span> <span style="color:#000">dep</span><span style="color:#000">,</span> <span style="color:#000">mapId</span><span style="color:#000">,</span> <span style="color:#000">context</span><span style="color:#000">,</span> <span style="color:#000">partition</span><span style="color:#000">)</span>
</span></span></code></pre></div><p>将 mapout 结果写出，其中由 shufflerWriterProcessor 调用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#000">writer</span> <span style="color:#a90d91">=</span> <span style="color:#000">manager</span><span style="color:#000">.</span><span style="color:#000">getWriter</span><span style="color:#000">[</span><span style="color:#a90d91">Any</span>, <span style="color:#a90d91">Any</span><span style="color:#000">](</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">dep</span><span style="color:#000">.</span><span style="color:#000">shuffleHandle</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">mapId</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">context</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">createMetricsReporter</span><span style="color:#000">(</span><span style="color:#000">context</span><span style="color:#000">))</span>
</span></span></code></pre></div><p>获取对应的 wrtier。</p>
<p>在 ShuffleRowRDD 中，<em>compute()</em> 中获取对应的 reader 并读入指定分区的 mapout。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">val</span> <span style="color:#000">reader</span> <span style="color:#a90d91">=</span> <span style="color:#000">split</span><span style="color:#000">.</span><span style="color:#000">asInstanceOf</span><span style="color:#000">[</span><span style="color:#a90d91">ShuffledRowRDDPartition</span><span style="color:#000">].</span><span style="color:#000">spec</span> <span style="color:#a90d91">match</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#3f6e75">CoalescedPartitionSpec</span><span style="color:#000">(</span><span style="color:#000">startReducerIndex</span><span style="color:#000">,</span> <span style="color:#000">endReducerIndex</span><span style="color:#000">,</span> <span style="color:#a90d91">_</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3f6e75">SparkEnv</span><span style="color:#000">.</span><span style="color:#000">get</span><span style="color:#000">.</span><span style="color:#000">shuffleManager</span><span style="color:#000">.</span><span style="color:#000">getReader</span><span style="color:#000">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">dependency</span><span style="color:#000">.</span><span style="color:#000">shuffleHandle</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">startReducerIndex</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">endReducerIndex</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">context</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">sqlMetricsReporter</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#3f6e75">PartialReducerPartitionSpec</span><span style="color:#000">(</span><span style="color:#000">reducerIndex</span><span style="color:#000">,</span> <span style="color:#000">startMapIndex</span><span style="color:#000">,</span> <span style="color:#000">endMapIndex</span><span style="color:#000">,</span> <span style="color:#a90d91">_</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3f6e75">SparkEnv</span><span style="color:#000">.</span><span style="color:#000">get</span><span style="color:#000">.</span><span style="color:#000">shuffleManager</span><span style="color:#000">.</span><span style="color:#000">getReader</span><span style="color:#000">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">dependency</span><span style="color:#000">.</span><span style="color:#000">shuffleHandle</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">startMapIndex</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">endMapIndex</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">reducerIndex</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">reducerIndex</span> <span style="color:#000">+</span> <span style="color:#1c01ce">1</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">context</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">sqlMetricsReporter</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#3f6e75">PartialMapperPartitionSpec</span><span style="color:#000">(</span><span style="color:#000">mapIndex</span><span style="color:#000">,</span> <span style="color:#000">startReducerIndex</span><span style="color:#000">,</span> <span style="color:#000">endReducerIndex</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3f6e75">SparkEnv</span><span style="color:#000">.</span><span style="color:#000">get</span><span style="color:#000">.</span><span style="color:#000">shuffleManager</span><span style="color:#000">.</span><span style="color:#000">getReader</span><span style="color:#000">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">dependency</span><span style="color:#000">.</span><span style="color:#000">shuffleHandle</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">mapIndex</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">mapIndex</span> <span style="color:#000">+</span> <span style="color:#1c01ce">1</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">startReducerIndex</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">endReducerIndex</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">context</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">sqlMetricsReporter</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">case</span> <span style="color:#3f6e75">CoalescedMapperPartitionSpec</span><span style="color:#000">(</span><span style="color:#000">startMapIndex</span><span style="color:#000">,</span> <span style="color:#000">endMapIndex</span><span style="color:#000">,</span> <span style="color:#000">numReducers</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3f6e75">SparkEnv</span><span style="color:#000">.</span><span style="color:#000">get</span><span style="color:#000">.</span><span style="color:#000">shuffleManager</span><span style="color:#000">.</span><span style="color:#000">getReader</span><span style="color:#000">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">dependency</span><span style="color:#000">.</span><span style="color:#000">shuffleHandle</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">startMapIndex</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">endMapIndex</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#1c01ce">0</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">numReducers</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">context</span><span style="color:#000">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">sqlMetricsReporter</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">}</span>
</span></span><span style="display:flex;"><span><span style="color:#177500">// map(_._2) get value
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">reader</span><span style="color:#000">.</span><span style="color:#000">read</span><span style="color:#000">().</span><span style="color:#000">asInstanceOf</span><span style="color:#000">[</span><span style="color:#a90d91">Iterator</span><span style="color:#000">[</span><span style="color:#a90d91">Product2</span><span style="color:#000">[</span><span style="color:#a90d91">Int</span>, <span style="color:#a90d91">InternalRow</span><span style="color:#000">]]].</span><span style="color:#000">map</span><span style="color:#000">(</span><span style="color:#a90d91">_</span><span style="color:#000">.</span><span style="color:#000">_2</span><span style="color:#000">)</span>
</span></span></code></pre></div><h3 id="externalsorter">ExternalSorter</h3>
<blockquote>
<p><a href="https://www.cnblogs.com/sunshuyi/p/12680918.html">TimSort 博客园</a></p>
<p><a href="https://en.wikipedia.org/wiki/Timsort">TimSort Wiki</a></p>
</blockquote>



        <style>
  .utterances {
    margin-top: 30svh;
    border-top: 1px solid var(--gray);
  }
</style>

<div id="utterances-container"></div>
<script>
  var repo = "huahuak/huahuak.github.io";
  var issueTerm = btoa(location.pathname);
  var theme = "github-light";
  (function () {
    var container = document.getElementById("utterances-container");
    var script = document.createElement("script");
    script.src = "https://utteranc.es/client.js";
    script.setAttribute("repo", repo);
    script.setAttribute("issue-term", issueTerm);
    script.setAttribute("theme", theme);
    script.crossorigin = "anonymous";
    script.async = true;
    container.appendChild(script);
  })();

</script>
      </main>
      <footer>  </footer>
    </div>
  </div>
</body>







<script>
  
  
  
  const localPrefix = "http://localhost:8080/Users/huahua/Library/Mobile%20Documents/com~apple~CloudDocs/HUAHUA/iNOTE";
  var localFunc = []
  window.onload = () => {
    fetch('http://localhost:8080/ping')
      .then((_1, _2) => { localFunc.forEach((f, _1, _2) => f()) })
      .catch(error => console.error('Error:', error));
  }

  
  
  
  function toggleVisibility() {
    let lbtn = document.getElementById("sidebar-lhs-button")
    let rbtn = document.getElementById("sidebar-rhs-button")
    var asideLayout = document.querySelector("div.aside-layout");
    var sidebar = document.getElementById("sidebar");
    if (sidebar.style.display === "none") {
      sidebar.style.display = "block"; 
      var rootStyles = getComputedStyle(document.documentElement);
      var asidePercent = rootStyles.getPropertyValue('--aside-percent');
      asideLayout.style.gridTemplateColumns = asidePercent;

      lbtn.style.display = "block"
      rbtn.style.display = "none"
    } else {
      sidebar.style.display = "none"; 
      asideLayout.style.gridTemplateColumns = '100svw';

      rbtn.style.display = "block"
      lbtn.style.display = "none"
    }
  }

  
  
  
  var oldScroll = 0
  function toggleSearch() {
    let search = document.getElementById("search")
    var main = document.getElementsByTagName("main")[0]
    if (search.style.display !== 'none') {
      search.style.display = 'none'
      main.scrollTop = oldScroll
    } else {
      search.style.display = 'block'
      document.getElementsByTagName('input')[0].focus()
      oldScroll = main.scrollTop
      main.scrollTop = 0
    }
  }

  
  
  
  var path = 'daily-note\/2022-11-02.md'
  localFunc.push(() => {
    document.getElementsByClassName("edit-ico")[0].style.display = "block"
  })
  function toggleEdit() {
    fetch(localPrefix + "/" + path)
      .catch(error => console.error('Error:', error));
  }

  
  var mediaQuery = window.matchMedia('(max-width: 600px)');
  if (mediaQuery.matches) {
    var sidebar = document.getElementById('sidebar');
    sidebar.addEventListener('click', function (event) {
      if (event.target.tagName === 'A') {
        toggleVisibility()
      }
    });

    document.getElementById("sidebar-rhs-button").style.display = "block"
  }

  
  
  
  const prefix = 'daily-note\/'
  var base = document.getElementsByTagName("main")[0]

  const wrapLink = link => {
    var pre = prefix
    if (link.includes("http")) {
      return link
    }
    if (link.startsWith("#")) {
      return link
    }
    if (link.startsWith("/")) {
      return link
    }
    if (prefix !== '/') {
      pre = '/' + prefix
    }
    link = pre + link
    link = link.replace(".md", "")
    return link
  }

  Array.from(base.getElementsByTagName('img')).forEach(item => {
    item.setAttribute('src', wrapLink(item.getAttribute('src')))
  })
  Array.from(base.getElementsByTagName('a')).forEach(item => {
    let old = item.getAttribute('href')
    let link = wrapLink(old)
    if (old !== link && link.includes(".")) {
      localFunc.push(() => {
        item.addEventListener('click', event => {
          event.preventDefault()
          fetch(localPrefix + link)
            .catch(error => console.error('Error:', error));
        })
      })
    }
    item.setAttribute('href', link)
  })

  
  
  
  var main = document.getElementsByTagName("main")[0]
  document.querySelectorAll('a[href^="#"]').forEach((v, _1, _2) => {
    v.addEventListener('click', function (e) {
      e.preventDefault();
      var targetId = this.getAttribute("href").slice(1);
      var targetElement = document.getElementById(targetId);
      if (targetElement) {
        main.scrollTo({
          top: targetElement.offsetTop - 54,
          behavior: 'smooth'
        });
      }
    })
  });

  
  
  
  main.addEventListener('scroll', function () {
    var sections = document.querySelectorAll('main h2, main h3');
    var scrollPosition = main.scrollTop + 54;
    for (var i = 0; i < sections.length; i++) {
      var currentSection = sections[i];
      if (scrollPosition >= sections[i].offsetTop && (i + 1 >= sections.length || scrollPosition < sections[i + 1].offsetTop)) {
        document.querySelector('#sidebar #TableOfContents a[href="#' + currentSection.id + '"]').style.fontWeight = 'bold';
      } else {
        document.querySelector('#sidebar #TableOfContents a[href="#' + currentSection.id + '"]').style.fontWeight = 'normal';
      }

    }
  });


  
  
  
  window.addEventListener('scroll', function () {
    window.scrollTo({ top: 0 })
  });
  window.addEventListener('DOMContentLoaded', (event) => {
    new PagefindUI({ element: "#search", showSubResults: true });
  });

</script>

</html>