<!DOCTYPE html>
<html lang="en"
  dir="ltr">

<head>
  
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)'], ['$', '$']]  
    }
  };
</script>
  
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title> | </title>

      <link rel="stylesheet" href="/css/main.min.4e3925258a07dcd1db9457696be79fd505b229e2280d31f3f622c14c35c26655.css" integrity="sha256-TjklJYoH3NHblFdpa&#43;ef1QWyKeIoDTHz9iLBTDXCZlU=" crossorigin="anonymous">
      <link rel="stylesheet" href="/css/var.min.f4ad28441b010d71b331e4a3acd0878a1f12df0c47c4e6d09c5087fa963c50f8.css" integrity="sha256-9K0oRBsBDXGzMeSjrNCHih8S3wxHxObQnFCH&#43;pY8UPg=" crossorigin="anonymous">


      <script src="/js/main.f2979a93a325fecf9605263bd141398a311c8e23388ed7dcff74f92f7e632866.js" integrity="sha256-8peak6Ml/s&#43;WBSY70UE5ijEcjiM4jtfc/3T5L35jKGY=" crossorigin="anonymous"></script>


<link rel="icon" type="image/ico" href="/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="/favicon.ico">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

</head>

<body>
  <div class="aside-layout">
    <aside id="sidebar"> <header>
  <div style="display: flex;">
    <button id="sidebar-lhs-button" onclick="toggleVisibility()" class="sidebar-ico"></button>
  </div>

  <div>
    <nav aria-label="breadcrumb" class="breadcrumb" style="display: flex; align-items: center;">
  <style>
    ol {
      margin: 0;
    }

    li {
      margin: 0;
    }

    .breadcrumb ol {
      padding-left: 0;
    }

    .breadcrumb li {
      display: inline;
    }

    .breadcrumb li:not(:last-child)::after {
       
      color: var(--blue);
      content: "Â·";
    }
  </style>
  <ol>
    
    <li>
      <a href="/"></a>
    </li>
    
    <li>
      <a href="/big_data/">Big_data</a>
    </li>
    
    <li class="active">
      <a aria-current="page" href="/big_data/spark/"></a>
    </li>
  </ol>
</nav>
  </div>
</header>

<div class="main-container">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#rdd-programming">RDD Programming</a>
      <ul>
        <li><a href="#example">Example</a></li>
        <li><a href="#representation">Representation</a></li>
        <li><a href="#compute">Compute</a></li>
        <li><a href="#parallel">Parallel</a></li>
        <li><a href="#distribution">Distribution</a></li>
        <li><a href="#how-spark-runs-a-job">How Spark runs a Job?</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div> </aside>
    <div id="right-board">
      <header> <div style="display: flex; align-items: center;">
  <button id="sidebar-rhs-button" style="display: none;" onclick="toggleVisibility()" class="sidebar-ico"></button>
  <a href="/" style="font-size: 2em; color: #222; text-decoration: none;">
    <span> HUAHUA </span>
  </a>
</div>

<div style="display: flex; align-items: center;">
  <button onclick="toggleEdit()" class="edit-ico" style="display: none;"></button>
  <button onclick="toggleSearch()" class="search-ico"></button>
  <a href="https://github.com/huahuak/huahuak.github.io">
    <span class="gh-ico"></span>
  </a>
</div>
 </header>
      <main class="center main-container">
        <link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>
<style>
  .pagefind-ui__result-thumb.svelte-4xnkmf.svelte-4xnkmf {
    display: none;
  }
</style>
<div id="search" style="display: none; margin-top: 0.5em;"></div>
        

<h1 id="spark">Spark</h1>
<h2 id="rdd-programming">RDD Programming</h2>
<blockquote>
<p>A Resilient Distributed Dataset (RDD), the basic abstraction in Spark. Represents an immutable, partitioned collection of elements that can be operated on in parallel.</p>
</blockquote>
<p>ç®€å•è€Œè¨€ï¼ŒRDD å¯ä»¥è§†ä½œåˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°ç»„ï¼Œæ‹¥æœ‰é«˜æ•ˆã€ç¨³å®šçš„ä¼˜ç‚¹ã€‚RDD é€šè¿‡å†…å­˜è®¡ç®—ã€åˆ†åŒºç­–ç•¥ (Partition) ä¸è°ƒåº¦ä¼˜åŒ–å™¨ (Scheduler) ä»¥å®ç°é«˜æ•ˆçš„å¹¶è¡Œè®¡ç®—ï¼ŒRDD ä¸å¯å˜æ€§ç‰¹ç‚¹ä¾¿äºå®ç°éƒ¨åˆ†ç¼“å­˜å¤‡ä»½ï¼Œå®¹é”™æ€§ä½¿å…¶åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å…·å¤‡ç¨³å®šçš„ä¼˜ç‚¹ã€‚</p>
<h3 id="example">Example</h3>
<blockquote>
<p><a href="https://github.com/apache/spark/blob/master/examples/src/main/python/wordcount.py">https://github.com/apache/spark/blob/master/examples/src/main/python/wordcount.py</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#177500"># word count</span>
</span></span><span style="display:flex;"><span><span style="color:#000">lines</span> <span style="color:#000">=</span> <span style="color:#000">spark</span><span style="color:#000">.</span><span style="color:#000">read</span><span style="color:#000">.</span><span style="color:#000">text</span>(<span style="color:#000">sys</span><span style="color:#000">.</span><span style="color:#000">argv</span>[<span style="color:#1c01ce">1</span>])<span style="color:#000">.</span><span style="color:#000">rdd</span><span style="color:#000">.</span><span style="color:#000">map</span>(<span style="color:#a90d91">lambda</span> <span style="color:#000">r</span>: <span style="color:#000">r</span>[<span style="color:#1c01ce">0</span>])
</span></span><span style="display:flex;"><span><span style="color:#000">counts</span> <span style="color:#000">=</span> <span style="color:#000">lines</span><span style="color:#000">.</span><span style="color:#000">flatMap</span>(<span style="color:#a90d91">lambda</span> <span style="color:#000">x</span>: <span style="color:#000">x</span><span style="color:#000">.</span><span style="color:#000">split</span>(<span style="color:#c41a16">&#39; &#39;</span>)) \
</span></span><span style="display:flex;"><span>              <span style="color:#000">.</span><span style="color:#000">map</span>(<span style="color:#a90d91">lambda</span> <span style="color:#000">x</span>: (<span style="color:#000">x</span>, <span style="color:#1c01ce">1</span>)) \
</span></span><span style="display:flex;"><span>              <span style="color:#000">.</span><span style="color:#000">reduceByKey</span>(<span style="color:#000">add</span>)
</span></span><span style="display:flex;"><span><span style="color:#000">output</span> <span style="color:#000">=</span> <span style="color:#000">counts</span><span style="color:#000">.</span><span style="color:#000">collect</span>()
</span></span><span style="display:flex;"><span><span style="color:#a90d91">for</span> (<span style="color:#000">word</span>, <span style="color:#000">count</span>) <span style="color:#000">in</span> <span style="color:#000">output</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">print</span>(<span style="color:#c41a16">&#34;</span><span style="color:#c41a16">%s</span><span style="color:#c41a16">: </span><span style="color:#c41a16">%i</span><span style="color:#c41a16">&#34;</span> <span style="color:#000">%</span> (<span style="color:#000">word</span>, <span style="color:#000">count</span>))
</span></span></code></pre></div><h3 id="representation">Representation</h3>
<blockquote>
<p>In a nutshell, we propose representing each RDD through a common interface that exposes five pieces of information: a set of partitions, which are atomic pieces of the dataset; a set of dependencies on parent RDDs; a function for computing the dataset based on its parents; and metadata about its partitioning scheme and data placement.<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
</blockquote>
<p>RDD ç”±åˆ†åŒºã€ä¾èµ–ã€è®¡ç®—å‡½æ•°ã€å…ƒæ•°æ®æ„æˆï¼Œé€šè¿‡åˆ†åŒºã€ä¾èµ–ã€è®¡ç®—å‡½æ•°æ„å»º RDD ä¹‹é—´çš„è®¡ç®—å›¾ï¼Œå…ƒæ•°æ®æ˜¯å„èŠ‚ç‚¹ç»„æˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<h3 id="compute">Compute</h3>
<p>RDD åŒ…æ‹¬ä¸¤ç±»åŸºæœ¬å‡½æ•°ï¼Œä¸€ç±»ä¸º Transformations (return a new RDD)ï¼Œå¦ä¸€ç±»ä¸º Actions (launch a job to return a value to the user program)ã€‚</p>
<blockquote>
<p>Table 2: Transformations and actions available on RDDs in Spark. Seq[T] denotes a sequence of elements of type T.<sup id="fnref1:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<p><img src="spark.assert/0c823c4b-3281-45b2-89b0-39e8eb3127cc.png?lastModify=1708517546" alt="0c823c4b-3281-45b2-89b0-39e8eb3127cc"></p>
</blockquote>
<ul>
<li><code>map</code> æ˜¯ Transformations ä¸­çš„åŸºæœ¬å‡½æ•°ï¼ŒæŒ‰ <code>f</code> å‡½æ•°åŠŸèƒ½æè¿°å®ç° RDD çš„è½¬æ¢ã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">def</span> <span style="color:#000">map</span><span style="color:#000">[</span><span style="color:#a90d91">U:</span> <span style="color:#a90d91">ClassTag</span><span style="color:#000">](</span><span style="color:#000">f</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">T</span> <span style="color:#000">=&gt;</span> <span style="color:#000">U</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">RDD</span><span style="color:#000">[</span><span style="color:#a90d91">U</span><span style="color:#000">]</span> <span style="color:#a90d91">=</span> <span style="color:#000">withScope</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">val</span> <span style="color:#000">cleanF</span> <span style="color:#a90d91">=</span> <span style="color:#000">sc</span><span style="color:#000">.</span><span style="color:#000">clean</span><span style="color:#000">(</span><span style="color:#000">f</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">new</span> <span style="color:#3f6e75">MapPartitionsRDD</span><span style="color:#000">[</span><span style="color:#a90d91">U</span>, <span style="color:#a90d91">T</span><span style="color:#000">](</span><span style="color:#a90d91">this</span><span style="color:#000">,</span> <span style="color:#000">(</span><span style="color:#a90d91">_</span><span style="color:#000">,</span> <span style="color:#a90d91">_</span><span style="color:#000">,</span> <span style="color:#000">iter</span><span style="color:#000">)</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">iter</span><span style="color:#000">.</span><span style="color:#000">map</span><span style="color:#000">(</span><span style="color:#000">cleanF</span><span style="color:#000">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">}</span>
</span></span></code></pre></div><ul>
<li><code>colect</code> æ˜¯ Actions ä¸­çš„å‡½æ•°ä¹‹ä¸€ï¼Œå…¶åŠŸèƒ½æ˜¯å°† RDD å„åˆ†åŒºå…ƒç´ æ”¶é›†è‡³ <code>driver</code>ã€‚ç”± <code>sc.runJob</code> å°†è®¡ç®—ä»»åŠ¡æäº¤å¹¶çœŸæ­£æ‰§è¡Œã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">def</span> <span style="color:#000">collect</span><span style="color:#000">()</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Array</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">]</span> <span style="color:#a90d91">=</span> <span style="color:#000">withScope</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">val</span> <span style="color:#000">results</span> <span style="color:#a90d91">=</span> <span style="color:#000">sc</span><span style="color:#000">.</span><span style="color:#000">runJob</span><span style="color:#000">(</span><span style="color:#a90d91">this</span><span style="color:#000">,</span> <span style="color:#000">(</span><span style="color:#000">iter</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Iterator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">])</span> <span style="color:#a90d91">=&gt;</span> <span style="color:#000">iter</span><span style="color:#000">.</span><span style="color:#000">toArray</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#3f6e75">Array</span><span style="color:#000">.</span><span style="color:#000">concat</span><span style="color:#000">(</span><span style="color:#000">results</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">_</span><span style="color:#a90d91">*</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">}</span>
</span></span></code></pre></div><h3 id="parallel">Parallel</h3>
<p>RDD æè¿°äº†æ•°æ®çš„å­˜åœ¨çŠ¶æ€ï¼Œé€šè¿‡ <code>Transformations</code> ç®—å­å®ç°çŠ¶æ€ä¹‹é—´çš„è½¬æ¢ï¼Œæ„å»ºæ•°æ®çš„è®¡ç®—å›¾ã€‚RDD å°†æ•°æ®åˆ’åˆ†ä¸ºå¤šä¸ªåˆ†åŒº (Partition)ï¼Œåˆ†åŒºæ˜¯è¿›è¡Œç‹¬ç«‹å¹¶è¡Œè®¡ç®—çš„åŸºæœ¬å•ä½ï¼Œå¹¶é€šè¿‡ä¾èµ– (Dependency) æè¿°åˆ†åŒºä¹‹é—´çš„æ•°æ®ä¾èµ–å…³ç³»ã€‚</p>
<img src="spark.assert/1276b9c6-292b-4184-9693-2733be76bdfc.png" alt="1276b9c6-292b-4184-9693-2733be76bdfc" style="width: 80%; display: block; margin: auto;" />
<p>RDD é€šè¿‡ <code>getPartitions</code> ä¸ <code>getDependencies</code> æ–¹æ³•æè¿°å¦‚ä½•è·å–åˆ†åŒºä¸ä¾èµ–ï¼Œåˆ†åŒºä¸ä¾èµ–æ˜¯æ„å»º RDD è®¡ç®—æµçš„åŸºç¡€ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">protected</span> <span style="color:#a90d91">def</span> <span style="color:#000">getPartitions</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Array</span><span style="color:#000">[</span><span style="color:#a90d91">Partition</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">protected</span> <span style="color:#a90d91">def</span> <span style="color:#000">getDependencies</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Seq</span><span style="color:#000">[</span><span style="color:#a90d91">Dependency</span><span style="color:#000">[</span><span style="color:#a90d91">_</span><span style="color:#000">]]</span> <span style="color:#a90d91">=</span> <span style="color:#000">deps</span>
</span></span></code></pre></div><blockquote>
<p>ğŸ“Œ <code>getPartitions</code> ä¸ <code>getDependencies</code> æ˜¯å­ç±»éœ€è¦é‡å†™çš„æ–¹æ³•ï¼Œå¤–éƒ¨è°ƒç”¨ API æ˜¯ <code>partitions</code> ä¸ <code>dependencies</code>ã€‚</p>
</blockquote>
<p>RDD <code>compute</code> æ–¹æ³•æ˜¯æ‰§è¡Œè®¡ç®—æµçš„å…¥å£ï¼Œ<code>split</code> å‚æ•°æè¿°äº†å½“å‰ RDD éœ€è¦è®¡ç®—çš„åˆ†åŒºï¼Œ<code>context</code> æ˜¯è®¡ç®—ä»»åŠ¡æºå¸¦çš„ä¸Šä¸‹æ–‡ã€‚<code>compute</code> æ‰€æ„å»ºçš„è®¡ç®—æ¨¡å¼æ˜¯æ ¹æ® <code>split</code> åˆ†åŒºä¸ RDD ä¹‹é—´çš„ä¾èµ–å…³ç³»è¿›è¡Œçš„åå‘è®¡ç®—ã€‚</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#a90d91">def</span> <span style="color:#000">compute</span><span style="color:#000">(</span><span style="color:#000">split</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Partition</span><span style="color:#000">,</span> <span style="color:#000">context</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">TaskContext</span><span style="color:#000">)</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">Iterator</span><span style="color:#000">[</span><span style="color:#a90d91">T</span><span style="color:#000">]</span>
</span></span></code></pre></div><h4 id="partition">Partition</h4>
<p>To-Do</p>
<h4 id="dependency">Dependency</h4>
<blockquote>
<p>We found it both sufficient and useful to classify dependencies into two types: <em>narrow</em> dependencies, where each partition of the parent RDD is used by at most one partistion of the child RDD, <em>wide</em> dependencies, where multiple child partitions may depend on it. For example, <em>map</em> leads to a narrow dependency, while <em>join</em> leads to to wide dependencies (unless the parents are hash-partitioned).<sup id="fnref2:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<img src="spark.assert/e44e3985-f2a9-4c68-a656-966fe4dc4f6a.png" style="width: 80%; display: block; margin: auto;">
</blockquote>
<p>ä¾èµ–åˆ†ä¸ºä¸¤ç±»åŸºæœ¬ä¾èµ–ï¼Œå³ <code>narrow dependencies</code> å’Œ <code>wide dependencies</code>ã€‚</p>
<h3 id="distribution">Distribution</h3>
<p>RDD ä¹‹é—´æ„æˆçš„è®¡ç®—å›¾ï¼Œæè¿°äº†æ•°æ®ä¹‹é—´çš„æµè½¬å…³ç³»ï¼Œåˆ†åŒºä¸ºå¹¶è¡Œè®¡ç®—æè¿°äº†æ•°æ®çš„åˆ’åˆ†æ–¹å¼ï¼Œä¾èµ–åˆ™æŒ‡æ˜åˆ†åŒºä¹‹é—´å­˜åœ¨çš„æ•°æ®ä¾èµ–å…³ç³»ã€‚é—®é¢˜åœ¨äºï¼ŒSpark å¦‚ä½•åŸºäº RDD æè¿°æ„å»ºåˆ†å¸ƒå¼è®¡ç®—ï¼Ÿ</p>
<p>ğŸ“Œ Spark å¦‚ä½•åŸºäº RDD æè¿°æ„å»ºåˆ†å¸ƒå¼è®¡ç®—ï¼Ÿ</p>
<blockquote>
<p><a href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwjW0_KfgbyEAxXqbmwGHUQHDmoQFnoECBYQAQ&amp;url=https%3A%2F%2Fzh.wikipedia.org%2Fzh-hans%2F%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%97&amp;usg=AOvVaw2Mcl2LiIuIBG6Bd4MsukjP&amp;opi=89978449">åˆ†å¸ƒå¼è®¡ç®— - Wikipedia</a></p>
<p>æŠŠéœ€è¦è¿›è¡Œå¤§é‡è®¡ç®—çš„å·¥ç¨‹æ•°æ®åˆ†å‰²æˆå°å—ï¼Œç”±å¤šå°<a href="https://zh.wikipedia.org/wiki/%E9%9B%BB%E5%AD%90%E8%A8%88%E7%AE%97%E6%A9%9F">è®¡ç®—æœº</a>åˆ†åˆ«è®¡ç®—ï¼Œå†ä¸Šä¼ è¿ç®—ç»“æœåï¼Œå°†ç»“æœç»Ÿä¸€åˆå¹¶å¾—å‡ºæ•°æ®ç»“è®ºçš„ç§‘å­¦ã€‚</p>
</blockquote>
<p>Wikipedia å¯¹åˆ†å¸ƒå¼è®¡ç®—çš„æè¿°åŒ…æ‹¬ä¸¤å°ç‚¹ï¼Œä¸€æ˜¯å°†è®¡ç®—æ•°æ®åˆ†å‰²æˆå°å—ï¼ŒäºŒæ˜¯å°†æ•°æ®äº¤ç”±å¤šå°è®¡ç®—æœºåˆ†åˆ«è®¡ç®—ä¸æ±‡æ€»è¿‡ç¨‹ï¼Œ<a href="#parallel">Parallel</a> å°èŠ‚è¯´æ˜äº† RDD åˆ†åŒºåˆ’åˆ†æ¦‚å¿µï¼Œæœ¬èŠ‚ <a href="#distribution">Distribution</a> å°†è¯´æ˜ RDD åˆ†åŒºè°ƒåº¦ä¸è®¡ç®—çš„è¿‡ç¨‹ã€‚</p>
<p>å®é™…ä¸Šï¼ŒSpark è®¡ç®—èŠ‚ç‚¹ä»¥ <code>Task</code> ä¸ºæœ€å°åŸºæœ¬å•ä½ï¼ŒæŒ‰çº¿ç¨‹çº§åˆ«æ‰§è¡Œå¹¶è¡Œè®¡ç®—ã€‚RDD æ‰€æ„æˆçš„è®¡ç®—å›¾ç»è¿‡åˆ‡åˆ†å¾—åˆ°è®¡ç®—çš„æœ€å°åŸºæœ¬å•ä½ <code>Task</code>ã€‚</p>
<blockquote>
<p>Whenever a user runs an action (<em>e.g., count</em> or <em>save</em>) on an RDD, the scheduler examines that RDDâ€™s lineage graph to build a DAG of <em>stages</em> to execute, as illustrated in Figure 5. Each stage contains as many pipelined transformations with narrow dependencies as possible. The boundaries of the stages are the shuffle operations required for wide dependencies, or any already computed partitions that can short-circuit the computation of a parent RDD. The scheduler then launches tasks to compute missing partitions from each stage until it has computed the target RDD.<sup id="fnref3:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<p>Job-Stage-Task ç¤ºæ„å›¾ï¼Œ</p>
<img src="spark.assert/5e08a822-497c-4aa6-8149-b5a741dae5a9.png" alt="5e08a822-497c-4aa6-8149-b5a741dae5a9" style="width: 80%; display: block; margin: auto;" />
</blockquote>
<p><strong>Job</strong> æ˜¯å¯¹ç”± RDD æ„æˆçš„è®¡ç®—å›¾è¿›è¡Œè®¡ç®—çš„ä»»åŠ¡å•ä½ï¼ŒSpark <code>DAGScheduler</code> è´Ÿè´£æ ¹æ® Job ä¸­çš„æ•°æ®ä¾èµ–å…³ç³»ï¼Œä¸»è¦æ˜¯  wide-dependency åˆ’åˆ†ä¸ºå¤šä¸ª Stage (wide-dependency å¤„ä¸‹æ¸¸ RDD ä¸­çš„åˆ†åŒºè®¡ç®—ä¾èµ–äºå¤šä¸ªä¸Šæ¸¸ RDD çš„åˆ†åŒºç»“æœï¼Œå³è®¡ç®—ä¸å¯è¿ç»­æ„æˆ Pipeline)ã€‚</p>
<p><strong>Stage</strong> åŒ…æ‹¬ä¸¤ç§ç±»å‹ Stageï¼Œåˆ†åˆ«æ˜¯ <code>ResultStage</code> ä¸ <code>ShuffleMapStage</code>ï¼Œå‰è€…å¯ä»¥è§†ä½œæ˜¯ final Stageï¼Œå³æœ€åçš„è¾“å‡ºç»“æœçš„ RDD åŠå…¶ narrow-dependency çš„ parents RDD æ‰€æ„æˆçš„ Stageï¼›åè€…å³ä¸ final Stage ä¹‹é—´å­˜åœ¨ wide-dependency çš„ä¸Šæ¸¸ Stageã€‚ç»è¿‡ wide-dependency åˆ’åˆ†åï¼Œ<code>ResultStage</code> ä¸ <code>ShuffleMapStage</code> å†…éƒ¨åªå­˜åœ¨ narrow-dependencyã€‚</p>
<p><strong>Task</strong> æ˜¯å¯¹ç”± Stage å†…éƒ¨ä¾èµ–çº¦æŸã€ç›¸åŒåˆ†åŒºæ‰€å½¢æˆçš„è®¡ç®—é“¾è¿›è¡Œè®¡ç®—çš„ä»»åŠ¡å•ä½ï¼ŒTask æ˜¯æœ€å°çš„ä»»åŠ¡å•ä½ï¼ŒTask ç»è°ƒåº¦å•å…ƒ (Scheduler) è½¬å‘è‡³æ‰§è¡Œå•å…ƒ (Executor)ï¼Œæ¯ä¸ª Task ç”±å•ç‹¬çš„çº¿ç¨‹è¿›è¡Œè®¡ç®—ã€‚</p>
<img src="spark.assert/e59f57ad-3e99-49aa-8556-33d03868b52a.png" alt="e59f57ad-3e99-49aa-8556-33d03868b52a" style="width: 80%; display: block; margin: auto;" />
<p><code>DAGScheduler</code> ä» RDD æ„æˆçš„è®¡ç®—å›¾ï¼Œç»è¿‡ Jobã€Stageã€Task çš„ç»†åŒ–æ‹†åˆ†åï¼Œæœ€åå°†éœ€è¦è¿›è¡Œè®¡ç®—çš„ Task æäº¤è‡³ <code>TaskScheduler</code>ï¼Œè€Œåè€…å°†è·Ÿè¸ªè¿™äº› Task ä»¥åŠç©ºé—²çš„è®¡ç®—èŠ‚ç‚¹ï¼ŒæŒ‰è°ƒåº¦ç­–ç•¥å°† Task åˆ†å‘è‡³å„è®¡ç®—èŠ‚ç‚¹ï¼Œå…¶ä¸­ä¸€ç§è°ƒåº¦ç­–ç•¥æ˜¯ï¼Œå°†ç©ºé—²çš„èŠ‚ç‚¹å…ˆè¿›è¡Œæ··æ·†ï¼Œå†ä¾æ¬¡åˆ†å‘å¾…è®¡ç®—çš„ä»»åŠ¡åˆ°å„èŠ‚ç‚¹ã€‚</p>
<h4 id="scheduler">Scheduler</h4>
<p>To-Do</p>
<h3 id="how-spark-runs-a-job">How Spark runs a Job?</h3>
<p>To-Do</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#177500">// getShuffleDependenciesAndResourceProfiles
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#a90d91">while</span> <span style="color:#000">(</span><span style="color:#000">waitingForVisit</span><span style="color:#000">.</span><span style="color:#000">nonEmpty</span><span style="color:#000">)</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">val</span> <span style="color:#000">toVisit</span> <span style="color:#a90d91">=</span> <span style="color:#000">waitingForVisit</span><span style="color:#000">.</span><span style="color:#000">remove</span><span style="color:#000">(</span><span style="color:#1c01ce">0</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a90d91">if</span> <span style="color:#000">(!</span><span style="color:#000">visited</span><span style="color:#000">(</span><span style="color:#000">toVisit</span><span style="color:#000">))</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">visited</span> <span style="color:#000">+=</span> <span style="color:#000">toVisit</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3f6e75">Option</span><span style="color:#000">(</span><span style="color:#000">toVisit</span><span style="color:#000">.</span><span style="color:#000">getResourceProfile</span><span style="color:#000">()).</span><span style="color:#000">foreach</span><span style="color:#000">(</span><span style="color:#000">resourceProfiles</span> <span style="color:#000">+=</span> <span style="color:#a90d91">_</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">toVisit</span><span style="color:#000">.</span><span style="color:#000">dependencies</span><span style="color:#000">.</span><span style="color:#000">foreach</span> <span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">case</span> <span style="color:#000">shuffleDep</span><span style="color:#a90d91">:</span> <span style="color:#a90d91">ShuffleDependency</span><span style="color:#000">[</span><span style="color:#a90d91">_</span>, <span style="color:#a90d91">_</span>, <span style="color:#a90d91">_</span><span style="color:#000">]</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">parents</span> <span style="color:#000">+=</span> <span style="color:#000">shuffleDep</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a90d91">case</span> <span style="color:#000">dependency</span> <span style="color:#a90d91">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">waitingForVisit</span><span style="color:#000">.</span><span style="color:#000">prepend</span><span style="color:#000">(</span><span style="color:#000">dependency</span><span style="color:#000">.</span><span style="color:#000">rdd</span><span style="color:#000">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">}</span>
</span></span></code></pre></div><div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="spark.assert/resilient_distributed_datasets_a_fault_tolerant_abstraction_for_in_memory_cluster_computing.pdf">resilient_distributed_datasets_a_fault_tolerant_abstraction_for_in_memory_cluster_computing.pdf</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref2:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref3:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>



        <style>
  .utterances {
    margin-top: 30svh;
    border-top: 1px solid var(--gray);
  }
</style>

<div id="utterances-container"></div>
<script>
  var repo = "huahuak/huahuak.github.io";
  var issueTerm = btoa(location.pathname);
  var theme = "github-light";
  (function () {
    var container = document.getElementById("utterances-container");
    var script = document.createElement("script");
    script.src = "https://utteranc.es/client.js";
    script.setAttribute("repo", repo);
    script.setAttribute("issue-term", issueTerm);
    script.setAttribute("theme", theme);
    script.crossorigin = "anonymous";
    script.async = true;
    container.appendChild(script);
  })();

</script>
      </main>
      <footer>  </footer>
    </div>
  </div>
</body>







<script>
  
  
  
  const localPrefix = "http://localhost:8080/Users/huahua/Library/Mobile%20Documents/com~apple~CloudDocs/HUAHUA/iNOTE";
  var localFunc = []
  window.onload = () => {
    fetch('http://localhost:8080/ping')
      .then((_1, _2) => { localFunc.forEach((f, _1, _2) => f()) })
      .catch(error => console.error('Error:', error));
  }

  
  
  
  function toggleVisibility() {
    let lbtn = document.getElementById("sidebar-lhs-button")
    let rbtn = document.getElementById("sidebar-rhs-button")
    var asideLayout = document.querySelector("div.aside-layout");
    var sidebar = document.getElementById("sidebar");
    if (sidebar.style.display === "none") {
      sidebar.style.display = "block"; 
      var rootStyles = getComputedStyle(document.documentElement);
      var asidePercent = rootStyles.getPropertyValue('--aside-percent');
      asideLayout.style.gridTemplateColumns = asidePercent;

      lbtn.style.display = "block"
      rbtn.style.display = "none"
    } else {
      sidebar.style.display = "none"; 
      asideLayout.style.gridTemplateColumns = '100svw';

      rbtn.style.display = "block"
      lbtn.style.display = "none"
    }
  }

  
  
  
  var oldScroll = 0
  function toggleSearch() {
    let search = document.getElementById("search")
    var main = document.getElementsByTagName("main")[0]
    if (search.style.display !== 'none') {
      search.style.display = 'none'
      main.scrollTop = oldScroll
    } else {
      search.style.display = 'block'
      document.getElementsByTagName('input')[0].focus()
      oldScroll = main.scrollTop
      main.scrollTop = 0
    }
  }

  
  
  
  var path = 'big_data\/spark.md'
  localFunc.push(() => {
    document.getElementsByClassName("edit-ico")[0].style.display = "block"
  })
  function toggleEdit() {
    fetch(localPrefix + "/" + path)
      .catch(error => console.error('Error:', error));
  }

  
  var mediaQuery = window.matchMedia('(max-width: 600px)');
  if (mediaQuery.matches) {
    var sidebar = document.getElementById('sidebar');
    sidebar.addEventListener('click', function (event) {
      if (event.target.tagName === 'A') {
        toggleVisibility()
      }
    });

    document.getElementById("sidebar-rhs-button").style.display = "block"
  }

  
  
  
  const prefix = 'big_data\/'
  var base = document.getElementsByTagName("main")[0]

  const wrapLink = link => {
    var pre = prefix
    if (link.includes("http")) {
      return link
    }
    if (link.startsWith("#")) {
      return link
    }
    if (link.startsWith("/")) {
      return link
    }
    if (prefix !== '/') {
      pre = '/' + prefix
    }
    link = pre + link
    link = link.replace(".md", "")
    return link
  }

  Array.from(base.getElementsByTagName('img')).forEach(item => {
    item.setAttribute('src', wrapLink(item.getAttribute('src')))
  })
  Array.from(base.getElementsByTagName('a')).forEach(item => {
    let old = item.getAttribute('href')
    let link = wrapLink(old)
    if (old !== link && link.includes(".")) {
      localFunc.push(() => {
        item.addEventListener('click', event => {
          event.preventDefault()
          fetch(localPrefix + link)
            .catch(error => console.error('Error:', error));
        })
      })
    }
    item.setAttribute('href', link)
  })

  
  
  
  var main = document.getElementsByTagName("main")[0]
  document.querySelectorAll('a[href^="#"]').forEach((v, _1, _2) => {
    v.addEventListener('click', function (e) {
      e.preventDefault();
      var targetId = this.getAttribute("href").slice(1);
      var targetElement = document.getElementById(targetId);
      if (targetElement) {
        main.scrollTo({
          top: targetElement.offsetTop - 54,
          behavior: 'smooth'
        });
      }
    })
  });

  
  
  
  main.addEventListener('scroll', function () {
    var sections = document.querySelectorAll('main h2, main h3');
    var scrollPosition = main.scrollTop + 54;
    for (var i = 0; i < sections.length; i++) {
      var currentSection = sections[i];
      if (scrollPosition >= sections[i].offsetTop && (i + 1 >= sections.length || scrollPosition < sections[i + 1].offsetTop)) {
        document.querySelector('#sidebar #TableOfContents a[href="#' + currentSection.id + '"]').style.fontWeight = 'bold';
      } else {
        document.querySelector('#sidebar #TableOfContents a[href="#' + currentSection.id + '"]').style.fontWeight = 'normal';
      }

    }
  });


  
  
  
  window.addEventListener('scroll', function () {
    window.scrollTo({ top: 0 })
  });
  window.addEventListener('DOMContentLoaded', (event) => {
    new PagefindUI({ element: "#search", showSubResults: true });
  });

</script>

</html>